┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Stash Pro Rules 架构图                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                         📱 流量入口                                        │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                          │
│                                      ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                    🔍 规则匹配（按优先级从上到下）                           │  │
│  ├──────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                          │  │
│  │  ① 私有网络 ─────────────────────────────────────────────→ 🎯 全球直连   │  │
│  │     GEOSITE,private / GEOIP,private                                      │  │
│  │                                                                          │  │
│  │  ② 自定义直连 ────────────────────────────────────────────→ 🎯 全球直连   │  │
│  │     RULE-SET,Custom_Direct_Classical                                     │  │
│  │                                                                          │  │
│  │  ③ AI 服务（高优先级）                                                    │  │
│  │     ├─ ChatGPT/OpenAI 域名 ─────────────────────────────→ 🤖 ChatGPT     │  │
│  │     ├─ Bing/Copilot ────────────────────────────────────→ 🤖 Copilot     │  │
│  │     └─ Gemini/Claude/Manus 等 ──────────────────────────→ 🤖 AI服务      │  │
│  │                                                                          │  │
│  │  ④ 谷歌服务（次高优先级）                                                  │  │
│  │     ├─ Google 核心域名 ─────────────────────────────────→ 🇬 谷歌服务     │  │
│  │     ├─ YouTube ─────────────────────────────────────────→ 🇬 谷歌服务     │  │
│  │     └─ GEOSITE,google ──────────────────────────────────→ 🇬 谷歌服务     │  │
│  │                                                                          │  │
│  │  ⑤ 其他功能分流                                                          │  │
│  │     ├─ 社交媒体 ─────→ 🌐 社交媒体    ├─ Steam ─────────→ 🎮 Steam       │  │
│  │     ├─ 即时通讯 ─────→ 💬 即时通讯    ├─ Spotify ───────→ 🎻 Spotify     │  │
│  │     ├─ GitHub ───────→ 🚀 GitHub      ├─ TikTok ────────→ 🎶 TikTok      │  │
│  │     ├─ OneDrive ─────→ 💾 OneDrive    ├─ Emby ──────────→ 🎥 Emby        │  │
│  │     ├─ 苹果服务 ─────→ 🍎 苹果服务    ├─ PayPal ────────→ 💳 PayPal      │  │
│  │     └─ 微软服务 ─────→ Ⓜ️ 微软服务    └─ 国外电商 ──────→ 🛒 国外电商     │  │
│  │                                                                          │  │
│  │  ⑥ GFW 列表 ──────────────────────────────────────────→ 🚀 主力代理      │  │
│  │                                                                          │  │
│  │  ⑦ 中国直连                                                               │  │
│  │     GEOSITE,cn / GEOIP,cn ────────────────────────────→ 🎯 全球直连      │  │
│  │                                                                          │  │
│  │  ⑧ 漏网之鱼（兜底）────────────────────────────────────→ 🐟 漏网之鱼     │  │
│  │                                                                          │  │
│  └──────────────────────────────────────────────────────────────────────────┘  │
│                                      │                                          │
│                                      ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────────────┐  │
│  │                         📦 策略组（出口选择）                               │  │
│  ├──────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                          │  │
│  │  ┌─────────────────── 🚀 主力代理（手动选择）───────────────────┐         │  │
│  │  │                                                              │         │  │
│  │  │  ♻️ 自动选择 ──────────────────────────────────────────────┐│         │  │
│  │  │     (url-test: 全部节点延迟测速，自动选最快)               ││         │  │
│  │  │                                                            ││         │  │
│  │  │  ┌──────────────── 🌍 地区分组 ────────────────────────┐   ││         │  │
│  │  │  │                                                     │   ││         │  │
│  │  │  │  🇺🇸 美国节点 (url-test)  ← 唯一不负载均衡的地区    │   ││         │  │
│  │  │  │  🇭🇰 香港节点 (load-balance: round-robin)          │   ││         │  │
│  │  │  │  🇯🇵 日本节点 (load-balance: round-robin)          │   ││         │  │
│  │  │  │  🇸🇬 新加坡节点 (load-balance: round-robin)        │   ││         │  │
│  │  │  │  🇼🇸 台湾节点 (load-balance: round-robin)          │   ││         │  │
│  │  │  │  🇰🇷 韩国节点 (load-balance: round-robin)          │   ││         │  │
│  │  │  │  🇬🇧 英国节点 (load-balance: round-robin)          │   ││         │  │
│  │  │  │  🇫🇷 法国节点 (load-balance: round-robin)          │   ││         │  │
│  │  │  │  🇩🇪 德国节点 (load-balance: round-robin)          │   ││         │  │
│  │  │  │  ... 其他地区                                       │   ││         │  │
│  │  │  │  🌐 其他地区 (select)                               │   ││         │  │
│  │  │  └─────────────────────────────────────────────────────┘   ││         │  │
│  │  │                                                              │         │  │
│  │  └──────────────────────────────────────────────────────────────┘         │  │
│  │                                                                           │  │
│  │  ┌─────────────────── 🔗 链式代理（特殊出口）──────────────────┐          │  │
│  │  │                                                             │          │  │
│  │  │   你 → 🇺🇸美国节点(出国) → 🏠落地机(家宽IP) → 目标网站     │          │  │
│  │  │                                                             │          │  │
│  │  │   用途：AI 服务需要稳定 IP，避免被检测为机房 IP             │          │  │
│  │  │   适用于：ChatGPT、Copilot、AI服务、谷歌服务                │          │  │
│  │  │                                                             │          │  │
│  │  └─────────────────────────────────────────────────────────────┘          │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                         🔧 DNS 配置（Fake-IP 模式）                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌─────────────┐    ┌─────────────┐    ┌──────────────────────────────────┐   │
│   │ 国内域名    │ → │ 国内 DNS    │ → │ 223.5.5.5 / 119.29.29.29         │   │
│   └─────────────┘    └─────────────┘    └──────────────────────────────────┘   │
│                                                                                 │
│   ┌─────────────┐    ┌─────────────┐    ┌──────────────────────────────────┐   │
│   │ 国外/被污染 │ → │ Fallback    │ → │ Cloudflare DoH / Google DoH      │   │
│   └─────────────┘    └─────────────┘    └──────────────────────────────────┘   │
│                                                                                 │
│   Fake-IP 范围：198.18.0.0/16（立即返回假 IP，加速连接建立）                    │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
